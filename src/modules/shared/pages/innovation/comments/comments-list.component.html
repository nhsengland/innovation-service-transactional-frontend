<ng-container *ngIf="module === 'accessor'">
  <div class="nhsuk-grid-row nhsuk-u-padding-bottom-3 d-flex align-items-center">
    <div class="nhsuk-grid-column-two-thirds">
      <p class="nhsuk-heading-l nhsuk-u-margin-bottom-0"> {{ innovation.name }} </p>
    </div>
    <div *ngIf="innovation.assessment.id" class="nhsuk-grid-column-one-third text-align-right">
      <a routerLink="/{{ module }}/innovations/{{ innovationId }}/assessments/{{ innovation.assessment.id }}">
        View needs assessment
      </a>
    </div>
  </div>
  <hr class="nhsuk-section-break nhsuk-section-break--visible nhsuk-u-margin-bottom-3" />
</ng-container>

<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">

    <theme-alert [type]="alert.type" [title]="alert.title" [setFocus]="alert.setFocus">
      <p> {{ alert.message }} </p>
    </theme-alert>

    <h1 class="nhsuk-u-margin-bottom-5"> {{ pageTitle }} </h1>

    <theme-spinner *ngIf="pageStatus === 'LOADING'" cssClass="nhsuk-u-margin-9"></theme-spinner>

    <ng-container *ngIf="pageStatus === 'READY'">
      <p>All comments can be seen by the innovator, needs assessment team, and selected support organisations depending on the innovator's sharing preferences.</p>

      <button class="nhsuk-button" [disabled]="!allSectionsSubmitted()" routerLink="/{{ module }}/innovations/{{ innovationId }}/comments/new"> Add new comment </button>
      <p *ngIf="!allSectionsSubmitted()">Submit your record before you add a new comment.</p>

      <div class="d-flex align-items-center justify-content-space-between nhsuk-u-margin-bottom-2">
        <div class="nhsuk-body-s font-color-secondary nhsuk-u-font-weight-bold nhsuk-u-margin-0"> Showing {{ commentsList.length }} results </div>
        <div class="d-flex">
          <a *ngIf="currentCreatedOrder === 'asc'" routerLink="/{{ module }}/innovations/{{ innovationId }}/comments" [queryParams]="{ createdOrder: 'desc' }"
            class="nhsuk-body-s nhsuk-u-margin-bottom-0 right-border-separator nhsuk-u-padding-right-3" aria-label="Sort comments by newest first">
            Newest first
          </a>
          <span *ngIf="currentCreatedOrder === 'desc'" class="nhsuk-body-s nhsuk-u-margin-bottom-0 right-border-separator nhsuk-u-padding-right-3">
            <span class="nhsuk-u-visually-hidden"> Comments are sorted by </span> Newest first
          </span>
          <a *ngIf="currentCreatedOrder === 'desc'" routerLink="/{{ module }}/innovations/{{ innovationId }}/comments" [queryParams]="{ createdOrder: 'asc' }" class="nhsuk-body-s nhsuk-u-margin-bottom-0 nhsuk-u-margin-left-3"
            aria-label="Sort comments by oldest first">
            Oldest first
          </a>
          <span *ngIf="currentCreatedOrder === 'asc'" class="nhsuk-body-s nhsuk-u-margin-bottom-0 nhsuk-u-margin-left-3">
            <span class="nhsuk-u-visually-hidden"> Comments are sorted by </span> Oldest first
          </span>
        </div>
      </div>
      <hr class="nhsuk-section-break nhsuk-section-break--visible nhsuk-u-margin-bottom-3" />

      <form [formGroup]="form">

        <ul class="nhsuk-grid-row nhsuk-card-group">
          <li *ngFor="let comment of commentsList" class="nhsuk-grid-column-full nhsuk-card-group__item">
            <div class="nhsuk-card nhsuk-u-padding-4">
              <div>
              <div class="d-flex justify-content-space-between nhsuk-u-margin-bottom-2" role="heading" aria-level="2">
                <div class="d-flex">
                  <div class="nhsuk-u-padding-right-2">
                    <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-0">{{ comment.user.name }}{{ comment.user.organisationUnit ? ', ' + comment.user.organisationUnit.name : '' }}</p>
                    <p class="nhsuk-body-s font-color-secondary nhsuk-u-margin-0">{{ getTeamTitle(comment.user.type) }}</p>
                  </div>
                  <notification-tag *ngIf="comment.notifications && comment.notifications.count > 0" type="circle"></notification-tag>
                </div>
                <p class="nhsuk-body-s font-color-secondary nhsuk-u-margin-0">
                  {{ comment.createdAt | date: ('app.date_formats.long_date_time' | translate) }}
                </p>
              </div>

              <p class="nhsuk-u-margin-0" style="word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">
                {{ comment.message }}
                <span *ngIf="comment.updatedAt" class="nhsuk-body-s font-color-secondary"> (last edited at 11 October 2021 at 10:14 AM)</span>
              </p>
              <a *ngIf="comment.is_editable && comment.user.id === userId" routerLink="/{{ module }}/innovations/{{ innovationId }}/comments/edit/{{ comment.id }}" [state]="{comment: comment.message}" class="nhsuk-body-s nhsuk-u-margin-bottom-4 nhsuk-u-margin-top-2">
                Edit this comment
              </a>
              <hr class="nhsuk-section-break nhsuk-section-break--visible nhsuk-u-margin-bottom-4 nhsuk-u-margin-top-4" />

              <p id="comment-reply-label-{{ comment.id }}" class="nhsuk-body-s font-color-secondary nhsuk-u-margin-0">
                Write a reply
                <span class="nhsuk-u-visually-hidden">
                  &nbsp; for comment made by {{ comment.user.name }} on {{ comment.createdAt | date: ('app.date_formats.long_date_time' | translate) }}. (Limited to {{ lengthLimitCharacters }} characters)
                </span>
              </p>

              <div class="nhsuk-form-group nhsuk-body-s nhsuk-u-margin-bottom-2" [ngClass]="{'nhsuk-form-group--error': formSubmittedFields[comment.id]}">
                <ng-container *ngIf="formSubmittedFields[comment.id]">
                  <span id="error-{{ comment.id }}" class="nhsuk-error-message nhsuk-u-font-size-14 nhsuk-u-margin-0" role="alert">
                    <span class="nhsuk-u-visually-hidden">Error:</span> {{ formSubmittedFields[comment.id] | translate }}
                  </span>
                </ng-container>
                <textarea #commentId id="comment-{{ comment.id }}" formControlName="{{ comment.id }}" [name]="comment.id" rows="5" [maxlength]="lengthLimitCharacters" class="nhsuk-textarea"
                  attr.aria-labelledby="comment-reply-label-{{ comment.id }}{{ formSubmittedFields[comment.id] ? ' error-' + comment.id : ''}}"></textarea>
                You have {{ lengthLimitCharacters - (commentId.value || '').length }} characters remaining
              </div>
              <button class="nhsuk-button button-small" (click)="onReply(comment.id)">
                Reply <span class="nhsuk-u-visually-hidden"> for comment made by {{ comment.user.name }} on {{ comment.createdAt | date: ('app.date_formats.long_date_time' | translate) }} </span>
              </button>
            </div>
              <hr *ngIf="comment.replies.length > 0" class="nhsuk-section-break nhsuk-section-break--visible nhsuk-u-margin-bottom-4 nhsuk-u-margin-top-4" />

              <div *ngFor="let reply of comment.replies" class="nhsuk-card bg-color-grey nhsuk-u-margin-bottom-3 nhsuk-u-padding-3">
                <div class="d-flex justify-content-space-between">
                  <p class="nhsuk-u-font-weight-bold nhsuk-u-margin-0">
                    {{ reply.user.name }}{{ reply.user.organisationUnit ? ', ' + reply.user.organisationUnit.name : '' }}
                  </p>
                  <notification-tag *ngIf="reply.notifications && reply.notifications.count > 0" class="nhsuk-u-padding-left-2 mr-auto" type="circle"></notification-tag>
                  <p class="nhsuk-body-s font-color-secondary nhsuk-u-margin-0">
                    {{ reply.createdAt | date: ('app.date_formats.long_date_time' | translate) }}
                  </p>
                </div>
                <p class="nhsuk-u-margin-0" style="word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">
                  {{ reply.message }}
                  <span *ngIf="reply.updatedAt" class="nhsuk-body-s font-color-secondary nhsuk-u-margin-bottom-2"> (last edited at 11 October 2021 at 10:14 AM)</span>
                </p>
                <a *ngIf="reply.is_editable" routerLink="/{{ module }}/innovations/{{ innovationId }}/comments/edit" class="nhsuk-body-s nhsuk-u-margin-bottom-0">
                  Edit this reply
                </a>
              </div>

              

            </div>
          </li>
        </ul>

      </form>

    </ng-container>

  </div>
</div>
