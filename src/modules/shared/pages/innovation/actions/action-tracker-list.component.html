<theme-content-wrapper [status]="pageStatus">

  <div *ngIf="!innovation.owner.isActive && !stores.authentication.isInnovatorType()" class="nhsuk-warning-callout nhsuk-u-margin-top-0">
    <div class="nhsuk-heading-m nhsuk-warning-callout__label">
      <span role="text"> <span class="nhsuk-u-visually-hidden">Important: </span> User Locked </span>
    </div>
    <p> Please note that the innovator {{ innovation.owner.name }} is currently locked. </p>
  </div>

  <a *ngIf="
      (innovation.support?.status === 'ENGAGING' || innovation.support?.status === 'FURTHER_INFO_REQUIRED') && stores.authentication.isAccessorType() || 
      (['NEEDS_ASSESSMENT','IN_PROGRESS','COMPLETE'].includes(innovation.status) && stores.authentication.isAssessmentType())"
    routerLink="/{{ userUrlBasePath() }}/innovations/{{ innovationId }}/action-tracker/new" class="nhsuk-button nhsuk-u-margin-bottom-7">
    Request new action
  </a>

  <ng-container *ngIf="openedActionsList.getTotalRowsNumber() === 0">
    <p> There are no open actions </p>
  </ng-container>

  <ng-container *ngIf="openedActionsList.getTotalRowsNumber() > 0">
    <h2>Open actions for innovation record</h2>

    <table class="nhsuk-table-responsive app-sortable-table nhsuk-u-padding-bottom-5">
      <caption class="nhsuk-table__caption nhsuk-u-visually-hidden"> Open actions list </caption>
      <thead class="nhsuk-table__head">
        <tr>
          <th *ngFor="let item of openedActionsList.getHeaderColumns(); let i = index" scope="col" [ngClass]="item.align" [attr.aria-sort]="item.orderDir">
            <ng-container *ngIf="!item.orderable">{{ item.label }}</ng-container>
            <button *ngIf="item.orderable" type="button">{{ item.label }}</button>
            <ng-container *ngIf="item.key === 'status'">
              <a routerLink="statuses" class="nhsuk-body-s nhsuk-u-margin-bottom-0 nhsuk-u-margin-top-1" arial-label="View status keys information"> Status key </a>
            </ng-container>
          </th>
        </tr>
      </thead>
      <tbody class="nhsuk-table__body">
        <tr *ngFor="let item of openedActionsList.getRecords()" class="nhsuk-table__row">
          <td class="nhsuk-table__cell">
            <span class="nhsuk-table-responsive__heading">{{ openedActionsList.getColumnLabel('id') }}</span>
            <span>{{ item.displayId }}</span>
          </td>
          <td class="nhsuk-table__cell">
            <div class="d-flex">
              <div class="nhsuk-u-padding-right-1">
                <span class="nhsuk-table-responsive__heading">{{ openedActionsList.getColumnLabel('name') }}</span>
                <a routerLink="/{{ userUrlBasePath() }}/innovations/{{ innovationId }}/action-tracker/{{ item.id }}" attr.aria-label="View {{ item.name }} action"> {{ item.name }} </a>
              </div>
              <theme-notification-tag label="dot" *ngIf="item.notifications"></theme-notification-tag>
            </div>
          </td>
          <td class="nhsuk-table__cell">
            <span class="nhsuk-table-responsive__heading">{{ openedActionsList.getColumnLabel('createdAt') }}</span>
            <span>{{ item.createdAt | date: ('app.date_formats.medium_date' | translate) }}</span>

            <span *ngIf="item.createdBy.role === 'ACCESSOR'; else requestedByOtherRole" class="nhsuk-body-s nhsuk-u-margin-bottom-0 font-color-secondary">by {{ item.createdBy.name }}, {{ item.createdBy.organisationUnit?.name }}</span>
            <ng-template #requestedByOtherRole>
              <span class="nhsuk-body-s nhsuk-u-margin-bottom-0 font-color-secondary">by {{ item.createdBy.name }} ({{ this.stores.authentication.getRoleDescription(item.createdBy.role) }})</span>
            </ng-template>
          </td>
          <td class="nhsuk-table__cell text-align-right">
            <span class="nhsuk-table-responsive__heading">{{ openedActionsList.getColumnLabel('status') }}</span>
            <theme-tag type="{{ 'shared.catalog.innovation.action_status.' + item.status + '.cssColorClass' | translate }}" label="{{ 'shared.catalog.innovation.action_status.' + item.status + '.name' | translate }}"></theme-tag>
          </td>
        </tr>
      </tbody>
    </table>
  </ng-container>

  <h2 class="nhsuk-u-margin-bottom-2">Closed actions for innovation record</h2>
  <details class="nhsuk-details nhsuk-u-padding-top-5" (click)="handleClosedActionsTableClick()">
    <summary class="nhsuk-details__summary">
      <span class="nhsuk-details__summary-text">
        All closed actions
      </span>
    </summary>
    <div class="nhsuk-details__text">

      <theme-spinner *ngIf="isClosedActionsLoading; else closedActionsLoaded"></theme-spinner>


      <ng-template #closedActionsLoaded>

        <p *ngIf="closedActionsList.getTotalRowsNumber() === 0"> There are no closed actions </p>

        <ng-container *ngIf="closedActionsList.getTotalRowsNumber() > 0">
          <table class="nhsuk-table-responsive app-sortable-table">
            <caption class="nhsuk-table__caption nhsuk-u-visually-hidden"> Closed actions list </caption>
            <thead class="nhsuk-table__head">
              <tr>
                <th *ngFor="let item of closedActionsList.getHeaderColumns(); let i = index" scope="col" [ngClass]="item.align" [attr.aria-sort]="item.orderDir">
                  <ng-container *ngIf="!item.orderable">{{ item.label }}</ng-container>
                  <button *ngIf="item.orderable" type="button">{{ item.label }}</button>
                  <ng-container *ngIf="item.key === 'status'">
                    <a routerLink="statuses" class="nhsuk-body-s nhsuk-u-margin-bottom-0 nhsuk-u-margin-top-1" arial-label="View status keys information"> Status key </a>
                  </ng-container>
                </th>
              </tr>
            </thead>
            <tbody class="nhsuk-table__body">
              <tr *ngFor="let item of closedActionsList.getRecords()" class="nhsuk-table__row">
                <td class="nhsuk-table__cell">
                  <span class="nhsuk-table-responsive__heading">{{ closedActionsList.getColumnLabel('id') }} </span>
                  <span>{{ item.displayId }}</span>
                </td>
                <td class="nhsuk-table__cell">
                  <div class="d-flex">
                    <div class="nhsuk-u-padding-right-1">
                      <span class="nhsuk-table-responsive__heading">{{ closedActionsList.getColumnLabel('name') }} </span>
                      <a routerLink="/{{ userUrlBasePath() }}/innovations/{{ innovationId }}/action-tracker/{{ item.id }}" attr.aria-label="View {{ item.name }} action"> {{ item.name }} </a>
                    </div>
                    <theme-notification-tag label="dot" *ngIf="item.notifications"></theme-notification-tag>
                  </div>
                </td>
                <td class="nhsuk-table__cell">
                  <span class="nhsuk-table-responsive__heading">{{ closedActionsList.getColumnLabel('createdAt') }} </span>
                  <span>{{ item.createdAt | date: ('app.date_formats.medium_date' | translate) }}</span>

                  <span *ngIf="item.createdBy.role === 'ACCESSOR'; else requestedByOtherRole" class="nhsuk-body-s nhsuk-u-margin-bottom-0 font-color-secondary">by {{ item.createdBy.name }}, {{ item.createdBy.organisationUnit?.name }}</span>
                  <ng-template #requestedByOtherRole>
                    <span class="nhsuk-body-s nhsuk-u-margin-bottom-0 font-color-secondary">by {{ item.createdBy.name }} ({{ this.stores.authentication.getRoleDescription(item.createdBy.role) }})</span>
                  </ng-template>
                </td>
                <td class="nhsuk-table__cell text-align-right">
                  <span class="nhsuk-table-responsive__heading">{{ closedActionsList.getColumnLabel('status') }} </span>
                  <theme-tag type="{{ 'shared.catalog.innovation.action_status.' + item.status + '.cssColorClass' | translate }}" label="{{ 'shared.catalog.innovation.action_status.' + item.status + '.name' | translate }}"></theme-tag>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="nhsuk-u-padding-bottom-4">
            <theme-pagination [currentPage]="closedActionsList.page" [pageSize]="closedActionsList.pageSize" [totalRows]="closedActionsList.getTotalRowsNumber()" (updatePageEvent)="onPageChange($event)"></theme-pagination>
          </div>
          
        </ng-container>

      </ng-template>
    </div>
  </details>


</theme-content-wrapper>
